import re
from datetime import datetime


# ============================
# üìû –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
# ============================
def normalize_phone(raw: str) -> str:
    """
    –ü—Ä–∏–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É +998XXXXXXXXX.
    –î–æ–ø—É—Å–∫–∞–µ—Ç –≤–≤–æ–¥: 911234567, 998911234567, +998911234567, 0911234567, 8-91-123-4567.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç "" –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å.
    """
    if not raw:
        return ""

    digits = re.sub(r"\D", "", raw)

    if len(digits) == 9:
        return f"+998{digits}"
    elif len(digits) == 12 and digits.startswith("998"):
        return f"+{digits}"
    elif len(digits) == 10 and digits.startswith("0"):
        return f"+998{digits[1:]}"
    elif len(digits) >= 11 and raw.strip().startswith("+"):
        return f"+{digits}"
    else:
        # fallback ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ
        return f"+998{digits[-9:]}" if len(digits) >= 9 else ""


# ============================
# üÜî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∂–∞–ª–æ–±—ã
# ============================
def generate_complaint_id(prefix: str = "J") -> str:
    """
    –°–æ–∑–¥–∞—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∂–∞–ª–æ–±—ã –≤–∏–¥–∞ J-250108143501.
    –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "A" –¥–ª—è –¥—Ä—É–≥–æ–π —Ç–∞–±–ª–∏—Ü—ã).
    """
    return f"{prefix}-{datetime.now().strftime('%y%m%d%H%M%S')}"


# ============================
# üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# ============================
def is_allowed_user(user_id: int, allowed_users: list[int]) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö."""
    if not allowed_users:
        return True  # –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ–º
    return user_id in allowed_users


# ============================
# ‚è∞ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
# ============================
def format_time(ts: datetime | None = None) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ '–¥–¥.–º–º.–≥–≥–≥–≥ —á—á:–º–º'"""
    ts = ts or datetime.now()
    return ts.strftime("%d.%m.%Y %H:%M")
